name: Manual Backfill (Jan-Feb)

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}
      CUSTOMER_ID: "1346816" # ë³¸ì¸ ID

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ì•„ë˜ ì¤„ì— pandasì™€ openpyxlì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!
          pip install requests python-dotenv sqlalchemy psycopg2-binary pandas openpyxl

      - name: Run Backfill Loop (Python)
        shell: python
        run: |
          import subprocess
          import time
          from datetime import date, timedelta

          # ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ì„¤ì • (1ì›” 1ì¼ ~ 2ì›” 14ì¼)
          start_date = date(2026, 1, 1)
          end_date = date(2026, 2, 14)

          current = start_date
          while current <= end_date:
              d_str = current.strftime("%Y-%m-%d")
              print(f"ğŸš€ [ìˆ˜ì§‘ ì‹œì‘] ë‚ ì§œ: {d_str}")
              
              # collector.py ì‹¤í–‰
              subprocess.run(["python", "collector.py", "--date", d_str])
              
              # í•˜ë£¨ ì¦ê°€
              current += timedelta(days=1)
              time.sleep(1) # ì„œë²„ ë³´í˜¸ë¥¼ ìœ„í•´ 1ì´ˆ íœ´ì‹
