name: Manual Backfill (3 Days Chunk)

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false # í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì§„í–‰
      matrix:
        period:
          # 2ì›” 1ì¼ ~ 2ì›” 21ì¼ (3ì¼ ë‹¨ìœ„ ë¶„í• )
          - {start: "2026-02-01", end: "2026-02-03"}
          - {start: "2026-02-04", end: "2026-02-06"}
          - {start: "2026-02-07", end: "2026-02-09"}
          - {start: "2026-02-10", end: "2026-02-12"}
          - {start: "2026-02-13", end: "2026-02-15"}
          - {start: "2026-02-16", end: "2026-02-18"}
          - {start: "2026-02-19", end: "2026-02-21"}

    env:
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}
      START_DATE: ${{ matrix.period.start }}
      END_DATE: ${{ matrix.period.end }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv sqlalchemy psycopg2-binary pandas openpyxl

      - name: Run Backfill Loop (Chunk)
        shell: python
        run: |
          import subprocess
          import time
          import os
          from datetime import datetime, timedelta

          start_str = os.getenv("START_DATE")
          end_str = os.getenv("END_DATE")
          
          print(f"ğŸ“Œ ì‘ì—… êµ¬ê°„: {start_str} ~ {end_str}")

          start_date = datetime.strptime(start_str, "%Y-%m-%d").date()
          end_date = datetime.strptime(end_str, "%Y-%m-%d").date()

          current = start_date
          while current <= end_date:
              d_str = current.strftime("%Y-%m-%d")
              print(f"ğŸš€ [ìˆ˜ì§‘ ì‹œì‘] ë‚ ì§œ: {d_str}")
              
              try:
                  # collector.py ì‹¤í–‰
                  subprocess.run(["python", "collector.py", "--date", d_str], check=True)
              except subprocess.CalledProcessError:
                  print(f"âŒ ì‹¤íŒ¨: {d_str}")
                  # í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‚ ì§œ ì§„í–‰
              
              current += timedelta(days=1)
              time.sleep(10) # ë„‰ë„‰í•˜ê²Œ 10ì´ˆ ëŒ€ê¸°í•˜ì—¬ DB ê³¼ë¶€í•˜ ë°©ì§€

          print("âœ… í•´ë‹¹ êµ¬ê°„ ìˆ˜ì§‘ ì™„ë£Œ")
