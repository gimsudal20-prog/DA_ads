name: Super Fast Backfill (10 Days Chunk)

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    
    strategy:
      max-parallel: 1 # DB ê³¼ë¶€í•˜ë¥¼ ë§‰ê¸° ìœ„í•´ 1ê°œ ë¬¶ìŒì”© ì°¨ë¡€ëŒ€ë¡œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
      fail-fast: false
      matrix:
        period:
          # 1ì›” 1ì¼ ~ 2ì›” 27ì¼ê¹Œì§€ 11~12ì¼ ë‹¨ìœ„ë¡œ ìª¼ê°¬
          - {start: "2026-01-01", end: "2026-01-11"}
          - {start: "2026-01-12", end: "2026-01-22"}
          - {start: "2026-01-23", end: "2026-02-03"}
          - {start: "2026-02-04", end: "2026-02-15"}
          - {start: "2026-02-16", end: "2026-02-27"}
  
    env:
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}
      START_DATE: ${{ matrix.period.start }}
      END_DATE: ${{ matrix.period.end }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv sqlalchemy psycopg2-binary pandas openpyxl

      - name: Run Express Backfill Loop
        shell: python
        run: |
          import subprocess
          import time
          import os
          from datetime import datetime, timedelta

          start_str = os.getenv("START_DATE")
          end_str = os.getenv("END_DATE")
          
          print(f"ğŸ“Œ ì‘ì—… êµ¬ê°„: {start_str} ~ {end_str}")

          start_date = datetime.strptime(start_str, "%Y-%m-%d").date()
          end_date = datetime.strptime(end_str, "%Y-%m-%d").date()

          current = start_date
          while current <= end_date:
              d_str = current.strftime("%Y-%m-%d")
              
              try:
                  # ğŸŒŸ í•µì‹¬: 10ë°°ì† ë¤í”„íŠ¸ëŸ­ ìœ ì§€ + ì—ëŸ¬ ì—†ì´ ì™„ë²½íˆ ê½‚ì•„ë„£ê¸°
                  subprocess.run(["python", "collector.py", "--date", d_str, "--skip_dim", "--workers", "10"], check=True)
              except subprocess.CalledProcessError:
                  print(f"âŒ ì‹¤íŒ¨: {d_str}")
              
              current += timedelta(days=1)
              time.sleep(3) 

          print(f"âœ… {start_str} ~ {end_str} êµ¬ê°„ ì¾Œì† ìˆ˜ì§‘ ì™„ë£Œ!")
