name: Manual Backfill (3 Days Chunk)

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false # í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì§„í–‰
      matrix:
        period:
          # 1ì›”
          - {start: "2026-01-01", end: "2026-01-03"}
          - {start: "2026-01-04", end: "2026-01-06"}
          - {start: "2026-01-07", end: "2026-01-09"}
          - {start: "2026-01-10", end: "2026-01-12"}
          - {start: "2026-01-13", end: "2026-01-15"}
          - {start: "2026-01-16", end: "2026-01-18"}
          - {start: "2026-01-19", end: "2026-01-21"}
          - {start: "2026-01-22", end: "2026-01-24"}
          - {start: "2026-01-25", end: "2026-01-27"}
          - {start: "2026-01-28", end: "2026-01-30"}
          - {start: "2026-01-31", end: "2026-02-02"}
          # 2ì›”
          - {start: "2026-02-03", end: "2026-02-05"}
          - {start: "2026-02-06", end: "2026-02-08"}
          - {start: "2026-02-09", end: "2026-02-11"}
          - {start: "2026-02-12", end: "2026-02-14"}
          - {start: "2026-02-15", end: "2026-02-17"}

    env:
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}
      START_DATE: ${{ matrix.period.start }}
      END_DATE: ${{ matrix.period.end }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv sqlalchemy psycopg2-binary pandas openpyxl

      - name: Run Backfill Loop (Chunk)
        shell: python
        run: |
          import subprocess
          import time
          import os
          from datetime import datetime, timedelta

          start_str = os.getenv("START_DATE")
          end_str = os.getenv("END_DATE")
          
          print(f"ğŸ“Œ ì‘ì—… êµ¬ê°„: {start_str} ~ {end_str}")

          start_date = datetime.strptime(start_str, "%Y-%m-%d").date()
          end_date = datetime.strptime(end_str, "%Y-%m-%d").date()

          current = start_date
          while current <= end_date:
              d_str = current.strftime("%Y-%m-%d")
              print(f"ğŸš€ [ìˆ˜ì§‘ ì‹œì‘] ë‚ ì§œ: {d_str}")
              
              try:
                  # collector.py ì‹¤í–‰
                  subprocess.run(["python", "collector.py", "--date", d_str], check=True)
              except subprocess.CalledProcessError:
                  print(f"âŒ ì‹¤íŒ¨: {d_str}")
                  # í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‚ ì§œ ì§„í–‰
              
              current += timedelta(days=1)
              time.sleep(2) # 3ì¼ì¹˜ë¼ ì§§ìœ¼ë¯€ë¡œ ì¿¨íƒ€ì„ì„ 2ì´ˆë¡œ ì¡°ê¸ˆ ëŠ˜ë ¤ ì•ˆì •ì„± í™•ë³´

          print("âœ… í•´ë‹¹ êµ¬ê°„ ìˆ˜ì§‘ ì™„ë£Œ")
