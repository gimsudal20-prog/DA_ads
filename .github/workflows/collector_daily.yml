name: Daily Naver Ads Collector

on:
  schedule:
    # UTC ê¸°ì¤€ 19ì‹œ, 1ì‹œ, 7ì‹œ, 13ì‹œ 
    # (í•œêµ­ ì‹œê°„ KST ê¸°ì¤€ 04:00, 10:00, 16:00, 22:00 -> 6ì‹œê°„ ê°„ê²©)
    - cron: "0 19,1,7,13 * * *"
  workflow_dispatch: {}

concurrency:
  group: collector-daily
  cancel-in-progress: false

jobs:
  run-collector:
    runs-on: ubuntu-latest
    env:
      # ì „ì²´ í™˜ê²½ì„ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ê³ ì •
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # pandas íŒ¨í‚¤ì§€ ëª…ì‹œì  ì¶”ê°€ (ëŒ€ìš©ëŸ‰ ë¦¬í¬íŠ¸ ì²˜ë¦¬ìš©)
          pip install requests python-dotenv sqlalchemy psycopg2-binary pandas

      - name: Run collector (Yesterday & Today)
        run: |
          echo "â° í˜„ì¬ í•œêµ­ ì‹œê°„: $(date +%H)ì‹œ"
          
          # 1. ì–´ì œ ë°ì´í„° ìˆ˜ì§‘ (ì§€ì—°ëœ ì „í™˜ ë° ë§¤ì¶œ ë³´ì •ì„ ìœ„í•´ ë§¤ë²ˆ ì‹¤í–‰)
          YESTERDAY=$(date -d "yesterday" +%F)
          echo "ğŸš€ Collect date (Yesterday) = ${YESTERDAY}"
          python collector.py --date "${YESTERDAY}"
          
          # 2. ì˜¤ëŠ˜ ë°ì´í„° ìˆ˜ì§‘ (ë‹¹ì¼ ì‹¤ì‹œê°„ ì„±ê³¼ í™•ì¸ìš©)
          TODAY=$(date +%F)
          echo "ğŸš€ Collect date (Today) = ${TODAY}"
          python collector.py --date "${TODAY}"
