name: Daily Naver Ads Collector

on:
  schedule:
    # UTC ê¸°ì¤€ 19ì‹œ, 1ì‹œ, 7ì‹œ, 13ì‹œ 
    # (í•œêµ­ ì‹œê°„ KST ê¸°ì¤€ 04:00, 10:00, 16:00, 22:00 -> 6ì‹œê°„ ê°„ê²©)
    - cron: "0 19,1,7,13 * * *"
  workflow_dispatch: {}

concurrency:
  group: collector-daily
  cancel-in-progress: false

jobs:
  run-collector:
    runs-on: ubuntu-latest
    env:
      # ì „ì²´ í™˜ê²½ì„ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ê³ ì •
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests python-dotenv sqlalchemy psycopg2-binary

      - name: Run collector (Smart Scheduler)
        run: |
          # í˜„ì¬ í•œêµ­ ì‹œê°„ì˜ 'ì‹œ(Hour)' ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì˜ˆ: 04, 10, 16, 22)
          CURRENT_HOUR=$(date +%H)
          echo "â° í˜„ì¬ í•œêµ­ ì‹œê°„: ${CURRENT_HOUR}ì‹œ"
          
          # 1. ì–´ì œ ë°ì´í„° (ìƒˆë²½ 4ì‹œì—ë§Œ 1ë²ˆ ìˆ˜ì§‘í•˜ì—¬ ìµœì¢… ë§ˆê°)
          if [ "$CURRENT_HOUR" == "04" ]; then
            YESTERDAY=$(date -d "yesterday" +%F)
            echo "ğŸš€ Collect date (Yesterday) = ${YESTERDAY}"
            python collector.py --date "${YESTERDAY}"
          else
            echo "â© ì–´ì œ ë°ì´í„° ìˆ˜ì§‘ íŒ¨ìŠ¤ (ìƒˆë²½ 4ì‹œì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.)"
          fi
          
          # 2. ì˜¤ëŠ˜ ë°ì´í„° (ì‹¤í–‰ë  ë•Œë§ˆë‹¤ í•­ìƒ ìˆ˜ì§‘)
          TODAY=$(date +%F)
          echo "ğŸš€ Collect date (Today) = ${TODAY}"
          python collector.py --date "${TODAY}"
