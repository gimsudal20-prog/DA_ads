name: Backfill Data (Manual)

on:
  workflow_dispatch: # ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ëˆŒëŸ¬ì„œ ì‹¤í–‰

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NAVER_ADS_API_KEY: ${{ secrets.NAVER_ADS_API_KEY }}
      NAVER_ADS_SECRET: ${{ secrets.NAVER_ADS_SECRET }}
      CUSTOMER_ID: "1346816" # ë³¸ì¸ ID í™•ì¸!

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests python-dotenv sqlalchemy psycopg2-binary

      - name: Run Backfill Loop (Jan 1 - Feb 14)
        run: |
          # ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ì„¤ì •
          start_date="2026-01-01"
          end_date="2026-02-14"

          current="$start_date"
          while [ "$current" != $(date -d "$end_date + 1 day" +%F) ]; do
            echo "-----------------------------------"
            echo "ğŸš€ ìˆ˜ì§‘ ì‹œì‘: $current"
            python collector.py --date "$current"
            
            # ë„¤ì´ë²„ ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ 3ì´ˆ ì‰¬ê¸°
            sleep 3
            
            # ë‹¤ìŒ ë‚ ì§œë¡œ ì´ë™
            current=$(date -d "$current + 1 day" +%F)
          done
